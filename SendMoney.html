<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Taisys</title>
	<link rel="apple-touch-icon" sizes="180x180" href="./images/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="./images/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="./images/favicon-16x16.png">
	<link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
	<link rel="icon" href="images/favicon.ico" type="image/x-icon">
	<!-- Tell the browser to be responsive to screen width -->
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
	<!-- Bootstrap 3.3.7 -->
	<link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
	<!-- Ionicons -->
	<link rel="stylesheet" href="bower_components/Ionicons/css/ionicons.min.css">

	<!--<link rel="stylesheet" href="css/bootstrap-datetimepicker.min.css">-->
	
	<!-- Select2 -->
	<link rel="stylesheet" href="bower_components/select2/dist/css/select2.min.css">	
	<!-- daterange picker -->
	<link rel="stylesheet" href="bower_components/bootstrap-daterangepicker/daterangepicker.css">

	<link rel="stylesheet" href="css/jquery-ui.min.css" type="text/css" /><!-- Jquery UI -->
	

	<!-- Theme style -->
	<link rel="stylesheet" href="dist/css/AdminLTE.min.css">
	<!-- AdminLTE Skins. Choose a skin from the css/skins
	folder instead of downloading all of them to reduce the load. -->
	<link rel="stylesheet" href="dist/css/skins/_all-skins.min.css">

	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
	
	<!-- Google Font -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
</head>
<body class="hold-transition skin-blue sidebar-mini">
<!-- Site wrapper -->
<div class="wrapper">

	<header class="main-header">
		<!-- Logo -->
		<a href="index2.html" class="logo">
			<!-- mini logo for sidebar mini 50x50 pixels -->
			<span class="logo-mini"><b id="sysLogoMini"></b></span>
			<!-- logo for regular state and mobile devices -->
			<span class="logo-lg" id="sysLogoLarge"><b></b></span>
		</a>
		<!-- Header Navbar: style can be found in header.less -->
		<nav class="navbar navbar-static-top">
			<!-- Sidebar toggle button-->
			<a href="#" class="sidebar-toggle" data-toggle="push-menu" role="button">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</a>
			
			<div class="navbar-custom-menu">
				<ul class="nav navbar-nav">
					<!-- User Account: style can be found in dropdown.less -->
					<li class="dropdown user user-menu">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown">
							<span class="hidden-xs sysCardId">No card paired</span>
						</a>
					</li>
				</ul>
			</div>
		</nav>
	</header>

	<!-- =============================================== -->
	
	<!-- Left side column. contains the sidebar -->
	<aside class="main-sidebar">
		<!-- sidebar: style can be found in sidebar.less -->
		<section class="sidebar">
			<!-- sidebar menu: : style can be found in sidebar.less -->
			<ul class="sidebar-menu" id="sysSidebarMenu" data-widget="tree"><!-- menu content is genarated by menu.js -->
				<li class="header">Main Navigation</li>
			</ul>
		</section>
		<!-- /.sidebar -->
	</aside>

	<!-- =============================================== -->
	
	<!-- Content Wrapper. Contains page content -->
	<div class="content-wrapper">
		<!-- Content Header (Page header) -->
		<section class="content-header">
			<h1>
				Send Money
				<small>Send money with <span class="currencyName" style="color:#FF0000;"></span> of wallet [<span class="sysWalletName" style="color:#FF0000;"></span>] in card <span class="sysCardId" style="color:#FF0000;"></span></small>
			</h1>
		</section>
		
		<!-- Main content -->
		<section class="content">

			<div class="alert alert-info alert-dismissible"><!-- info window -->
				<button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
				<h4><i class="icon fa fa-info"></i> Information</h4>
				<ul>
					<li>Please enter the destination address and amount, then click Send button</li>
				</ul>
			</div><!-- info window -->

			<div id="existingCurrencies">
			</div>

			<div class="row">
				<div class="col-lg-6 col-xs-12">
					<div class="box">
						<div class="box-header with-border">
							<h3 class="box-title">Send&nbsp;<span class="currencyName"></span>&nbsp;<span id="availableMoney"></span></h3>
						</div><!-- /.box-header -->
						<div class="box-body">
							<form role="form">
								<!-- text input -->
								<div class="form-group">
									<label>Address</label>
									<input type="text" id="beneficiaryAddress" class="form-control" placeholder="Beneficiary address">
								</div>
								<!-- text input -->
								<div class="form-group">
									<label>Amount</label>
									<input type="text" id="amountToBeSent" class="form-control" placeholder="Amount to be sent">
								</div>
								<!-- text input -->
								<div class="form-group">
									<label>Fee</label>
									<input type="text" id="transactionFee" class="form-control" placeholder="" disabled>
								</div>
							</form>
						</div><!-- /.box-body -->
						<div class="box-footer clearfix">
							<div class="col-lg-12 col-xs-12">
								<button type="button" id="transactionBtn" class="btn btn-block btn-danger btn-lg" onclick="doSend();">Send</button>
							</div>
						</div><!-- /.box-footer -->
					</div><!-- /.box -->
				</div><!-- /.col -->
			</div><!-- row -->


		</section><!-- /.content -->
	</div><!-- /.content-wrapper -->

	<footer class="main-footer">
		<div class="pull-right hidden-xs">
			Powered by <a href="https://adminlte.io" target="_blank">Almsaeed Studio</a>
		</div>
		<strong>Copyright &copy; 2019 <a href="https://www.taisys.com.tw/" target="_blank">Taisys</a>.</strong> All rights reserved.
	</footer>

</div>
<!-- ./wrapper -->

<div class="hidden" id="entropybucket"></div>
</body>
</html>

<!-- jQuery 3 -->
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<!-- Bootstrap 3.3.7 -->
<script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<!--<script type="text/javascript" src="js/moment.min.js"></script>-->
<!--<script type="text/javascript" src="js/bootstrap-datetimepicker.min.js"></script>-->
<script type="text/javascript" src="js/crypto-min.js"></script>
<script type="text/javascript" src="js/crypto-sha256.js"></script>
<script type="text/javascript" src="js/crypto-sha256-hmac.js"></script>
<script type="text/javascript" src="js/sha512.js"></script>
<script type="text/javascript" src="js/ripemd160.js"></script>
<script type="text/javascript" src="js/aes.js"></script>
<script type="text/javascript" src="js/jsbn.js"></script>
<!--<script type="text/javascript" src="js/ellipticcurve.js"></script>-->

<!-- SlimScroll -->
<script src="bower_components/jquery-slimscroll/jquery.slimscroll.min.js"></script>
<!-- FastClick -->
<script src="bower_components/fastclick/lib/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="dist/js/adminlte.min.js"></script>

<script type="text/javascript" src="js/jquery-ui.min.js"></script>
<script type="text/javascript" src="js/jquery.blockUI.js"></script>
<script type="text/javascript" src="js/util.js"></script>
<script type="text/javascript" src="js/jquery.cookie.js"></script><!--處理cookie，參考網頁：https://github.com/carhartl/jquery-cookie -->
<script type="text/javascript" src="js/util.js"></script>
<script type="text/javascript" src="js/menu.js"></script>

<script type="text/javascript" src="js/coin.js"></script>
<!--<script type="text/javascript" src="js/coinbin.js"></script>-->

<!-- Select2 -->
<script src="bower_components/select2/dist/js/select2.full.min.js"></script>

<script>
	$(document).ready(function () {
		checkAppCardWalletAndCurrency();
	})
</script>

<script>
	var appId = "";
	var cardId = "";
	var walletId = "";
	var walletName = "";
	var currencyRowId = "";
	var currencyId = "";
	var currencyName = "";
	var currencyPublicKey = "";
	var currencyAddress = "";
	var unspentTransaction = null;
	var totalUnspent = 0.0;
	var minFee = 0.0;	//1 input + 1 output 約 225 bytes
	var feeBtcSatPerByte = 34;	//每byte給多少 Sat (聰)

	function checkAppCardWalletAndCurrency(){
		appId = getLocalValue("SCWSysAppId");
		cardId = getLocalValue("SCWSysCardId");
		walletId = getLocalValue("SCWSysWalletId");
		walletName = getLocalValue("SCWSysWalletName");
		currencyRowId = getLocalValue("SCWSysCurrencyRowId");
		currencyId = getLocalValue("SCWSysCurrencyId");
		currencyName = getLocalValue("SCWSysCurrencyName");
		currencyPublicKey = getLocalValue("SCWSysCurrencyPublicKey");
		currencyAddress = getLocalValue("SCWSysCurrencyAddress");
		if (beEmpty(appId) || beEmpty(cardId) || beEmpty(walletId) || beEmpty(walletName) || beEmpty(currencyRowId) || beEmpty(currencyId) || beEmpty(currencyName) || beEmpty(currencyPublicKey) || beEmpty(currencyAddress)){
			msgBox("Information not enough, please ensure you had paired this application with your card, select a wallet, and click [Send] button on the <a href='CheckBalance.html'>Check Balance page</a>!", function(){location.href="index.html";});
			return;
		}else{
			$('.currencyName').text(currencyName);
			//$('.currencyAddress').text(currencyAddress);
			getUnsentTransaction();
		}
	}

	function getUnsentTransaction(){
		var sUrl = "";
		if (currencyId == "BTCTEST")	sUrl = "https://chain.so/api/v2/get_tx_unspent/BTCTEST/" + currencyAddress;
		if (currencyId == "BTC")		sUrl = "https://chain.so/api/v2/get_tx_unspent/BTC/" + currencyAddress;
		if (currencyId == "BTCTEST" || currencyId == "BTC") minFee = 0.00007425;	//1 input + 1 output
		//if (currencyId == "BTCTEST" || currencyId == "BTC") minFee = 0.00012276;	//2 input + 2 output

		$.getJSON( sUrl, function(data) {
			totalUnspent = 0.0;
			if (beEmpty(data.status) || data.status!="success"){
				msgBox("Fail to get unspent data for " + currencyId + ": " + currencyAddress);
				return;
			}
			unspentTransaction = data.data;
			$.each( data.data.txs, function(i, r) {
				totalUnspent += parseFloat(r.value);
			});	//$.each( data.data.txs, function(i, r) {
			if (totalUnspent<minFee){
				msgBox("No available money.");
				return;
			}
			totalUnspent = totalUnspent.toFixed(8);	//小數點後8位
			$('#availableMoney').text(", maximum available money = " + (totalUnspent-minFee).toString());
			$('#transactionFee').val(minFee);
		})
		.fail(function(d) {
			msgBox("Failed to get unspent money");
			$('#availableMoney').text("Failed to get unspent money");
		});	//$.getJSON( "./point.json", function(data) { 

	}	//function getUnsentTransaction(){
	
	function doSend(){
		if (!checkUnspentMoney()) return;
		generateRawTransactionData();
	}	//function doSend(){
	
	function checkUnspentMoney(){
		var amountToBeSent = parseFloat($('#amountToBeSent').val());
		if (beEmpty($('#beneficiaryAddress').val())){
			msgBox("Please input beneficiary address");
			return false;
		}
		if (beEmpty($('#amountToBeSent').val()) || amountToBeSent>(totalUnspent-minFee)){
			msgBox("You are trying to send " + amountToBeSent.toString() + ", but have a balance of " + (totalUnspent-minFee).toString());
			return false;
		}
		return true;
	}	//function checkUnspentMoney(){
	
	function generateRawTransactionData(){
		var amountToBeSent = parseFloat($('#amountToBeSent').val());
		var tx = coinjs.transaction();
		var estimatedTxSize = 10; // <4:version><1:txInCount><1:txOutCount><4:nLockTime>
		var hasError = false;
		var addedMoney = 0.0;
		var ad = null;
		var totalFee = 0.00000000;
		$.each(unspentTransaction.txs, function(i,o){
			if(!(o.txid).match(/^[a-f0-9]+$/i)){
				hasError = true;
			} else if((!(o.script_hex).match(/^[a-f0-9]+$/i)) && $(".txIdScript",o).val()!=""){
				hasError = true;
			} else if (!(o.output_no).toString().match(/^[0-9]+$/i)){
				hasError = true;
			}
console.log("0 estimatedTxSize= " + estimatedTxSize.toString());
			if(!hasError){
				var seq = null;

				var currentScript = o.script_hex;
				if (currentScript.match(/^76a914[0-9a-f]{40}88ac$/)) {
					estimatedTxSize += 147;
console.log("1 estimatedTxSize= " + estimatedTxSize.toString());
				} else if (currentScript.match(/^5[1-9a-f](?:210[23][0-9a-f]{64}){1,15}5[1-9a-f]ae$/)) {
					// <74:persig <1:push><72:sig><1:sighash> ><34:perpubkey <1:push><33:pubkey> > <32:prevhash><4:index><4:nSequence><1:m><1:n><1:OP>
					var scriptSigSize = (parseInt(currentScript.slice(1,2),16) * 74) + (parseInt(currentScript.slice(-3,-2),16) * 34) + 43;
					// varint 2 bytes if scriptSig is > 252
					estimatedTxSize += scriptSigSize + (scriptSigSize > 252 ? 2 : 1);
console.log("2 estimatedTxSize= " + estimatedTxSize.toString());
				} else {
					// underestimating won't hurt. Just showing a warning window anyways.
					estimatedTxSize += 147;
console.log("3 estimatedTxSize= " + estimatedTxSize.toString());
				}
				tx.addinput(o.txid, (o.output_no).toString(), o.script_hex, seq);
				addedMoney += parseFloat(o.value);
				console.log(i.toString() + ", addedMoney=" + addedMoney);
				totalFee = (estimatedTxSize + getBeneficiaryOutputDataSize())*feeBtcSatPerByte/100000000;
				console.log(i.toString() + "totalFee=" + totalFee);
				console.log("addedMoney=" + addedMoney.toString());
				console.log("amountToBeSent=" + amountToBeSent.toString());
				console.log("totalFee=" + totalFee.toString());
				if (addedMoney==(amountToBeSent+totalFee)) alert("1");
				if (addedMoney>(amountToBeSent+totalFee)) alert("2");
				if (addedMoney<(amountToBeSent+totalFee)) alert("3");
				if (addedMoney==(amountToBeSent+totalFee)){
					console.log("false 0");
					return false; // 等於break
				}else if (addedMoney>(amountToBeSent+totalFee)){
					
					ad = coinjs.addressDecode(currencyAddress);
					// P2SH output is 32, P2PKH is 34
					estimatedTxSize += (ad.version == coinjs.pub || ad.version == coinjs.pubtest ? 34 : 32)
					totalFee = (estimatedTxSize + getBeneficiaryOutputDataSize())*feeBtcSatPerByte/100000000;
					console.log(i.toString() + " else totalFee=" + totalFee);
					if (addedMoney==(amountToBeSent+totalFee)){
						console.log("false 1");
						return false; // 等於break
					}else if (addedMoney>(amountToBeSent+totalFee)){
						tx.addoutput(currencyAddress, (addedMoney-amountToBeSent-totalFee).toString());
						console.log(i.toString() + ", estimatedTxSize=" + estimatedTxSize.toString()+", add out amount" +(addedMoney-amountToBeSent-totalFee).toString());
						console.log("false 2");
						return false; // 等於break
					}
				}
			} else {
				msgBox("Parsing error with the unspent data");
				hasError = true;
				return false;
			}
		});

		if (!hasError){
			var a = ($('#beneficiaryAddress').val());
			var ad = coinjs.addressDecode(a);
			//console.log(ad);
			if(((a!="") && (ad.version == coinjs.pub || ad.version == coinjs.pubtest || ad.version == coinjs.multisig || ad.type=="bech32")) && $('#amountToBeSent').val()!=""){ // address
				// P2SH output is 32, P2PKH is 34
				estimatedTxSize += (ad.version == coinjs.pub || ad.version == coinjs.pubtest ? 34 : 32)
console.log("5 estimatedTxSize= " + estimatedTxSize.toString());
				tx.addoutput(a, $('#amountToBeSent').val());
			} else if (((a!="") && ad.version === 42) && $('#amountToBeSent').val()!=""){ // stealth address
				// 1 P2PKH and 1 OP_RETURN with 36 bytes, OP byte, and 8 byte value
				estimatedTxSize += 78
				tx.addstealth(ad, $('#amountToBeSent').val());
console.log("6 estimatedTxSize= " + estimatedTxSize.toString());
			} else if (((($("#opReturn").is(":checked")) && a.match(/^[a-f0-9]+$/ig)) && a.length<160) && (a.length%2)==0) { // data
				estimatedTxSize += (a.length / 2) + 1 + 8
				tx.adddata(a);
console.log("7 estimatedTxSize= " + estimatedTxSize.toString());
			} else { // neither address nor data
				hasError = true;
				msgBox("The address you entered is invalid");
				return;
			}
		}

		if (!hasError){
			totalFee = estimatedTxSize*feeBtcSatPerByte/100000000;
			console.log("total estimatedTxSize= " + estimatedTxSize.toString() + ", totalFee=" + totalFee.toString());
			console.log(tx.serialize());
		}

	}	//function generateRawTransactionData(){
	
	function getBeneficiaryOutputDataSize(){
		var estimatedTxSize = 0;
		var a = ($('#beneficiaryAddress').val());
		var ad = coinjs.addressDecode(a);
		//console.log(ad);
		if(((a!="") && (ad.version == coinjs.pub || ad.version == coinjs.pubtest || ad.version == coinjs.multisig || ad.type=="bech32")) && $('#amountToBeSent').val()!=""){ // address
			// P2SH output is 32, P2PKH is 34
			estimatedTxSize += (ad.version == coinjs.pub || ad.version == coinjs.pubtest ? 34 : 32)
		} else if (((a!="") && ad.version === 42) && $('#amountToBeSent').val()!=""){ // stealth address
			// 1 P2PKH and 1 OP_RETURN with 36 bytes, OP byte, and 8 byte value
			estimatedTxSize += 78
		} else if (((($("#opReturn").is(":checked")) && a.match(/^[a-f0-9]+$/ig)) && a.length<160) && (a.length%2)==0) { // data
			estimatedTxSize += (a.length / 2) + 1 + 8
		} else { // neither address nor data
			msgBox("The address you entered is invalid");
		}
		return estimatedTxSize;
	}
</script>

